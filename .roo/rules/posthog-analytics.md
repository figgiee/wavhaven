---
description: 
globs: src/components/providers/PostHogProvider.tsx,src/lib/posthog-server.ts,**/*.ts,**/*.tsx
alwaysApply: false
---
---
ruleType: Auto Attached
filePatterns:
  - "src/components/providers/PostHogProvider.tsx" # Provider setup
  - "src/lib/posthog-server.ts"                   # Server client setup (if exists)
  - "**/*.{ts,tsx}"                               # Broadly apply where events might be tracked
description: Conventions for using PostHog analytics, including user identification (registered/guest), aliasing, event tracking (client/server), and setup.
---
# PostHog Analytics Conventions for Wavhaven

- **Setup:** Use the `PostHogProvider` (`src/components/providers/`) wrapping the application layout. Use both client-side and server-side PostHog clients where appropriate.
- **User Identification:**
    - **Registered Users:** Call `posthog.identify(clerkId, { email, name, role })` when the user logs in or their data is available (e.g., in the Provider).
    - **Guests:** Tracked automatically via the anonymous ID generated by PostHog.js.
    - **Aliasing:** When a guest signs up or logs in for the first time, capture their previous anonymous ID (e.g., from PostHog cookie or state) and call `posthog.alias(newClerkId, previousAnonymousId)` to link pre- and post-signup activity. This is crucial for tracking conversion funnels.
- **Event Tracking:**
    - Track key events specified in the tech spec (Section 11): `track_uploaded`, `track_searched`, `track_preview_played`, `item_added_to_cart`, `checkout_started`, `order_completed`, `file_downloaded`, etc.
    - Track events from both client-side (e.g., button clicks, form submissions) and server-side (e.g., successful uploads, order fulfillment in webhooks/actions).
    - Include relevant properties with events (e.g., `trackId`, `licenseId`, `totalAmount`, `userType: 'guest' | 'registered'`). Be mindful of PII - avoid sending sensitive data directly unless necessary and compliant.
- **Environment Variables:** Ensure PostHog keys (Public Key, API Key) and host are set in `.env`.